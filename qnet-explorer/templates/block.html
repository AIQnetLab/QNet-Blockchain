{% extends "base.html" %}
{% block title %}Block #{{ block.index }} - QNet Explorer{% endblock %}
{% block bodyclass %}page-explorer{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">Block #{{ block.index }}</h1>
    <div>
        <a href="{{ url_for('blocks_list') }}" class="btn btn-outline-primary btn-sm">All Blocks</a>
        <a href="{{ url_for('block_detail', height=block.index-1) }}" class="btn btn-outline-primary btn-sm {% if block.index == 0 %}disabled{% endif %}">Previous Block</a>
        <a href="{{ url_for('block_detail', height=block.index+1) }}" class="btn btn-outline-primary btn-sm {% if block.index >= blockchain_info.height %}disabled{% endif %}">Next Block</a>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        Block Information
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <table class="table table-borderless">
                    <tbody>
                        <tr>
                            <th style="width: 150px">Height:</th>
                            <td>{{ block.index }}</td>
                        </tr>
                        <tr>
                            <th>Timestamp:</th>
                            <td>{{ block.time }} ({{ block.time_ago }})</td>
                        </tr>
                        <tr>
                            <th>Transactions:</th>
                            <td>{{ block.transactions|length }}</td>
                        </tr>
                        <tr>
                            <th>Producer:</th>
                            <td>
                                {% if block.producer %}
                                <a href="{{ url_for('address_detail', address=block.producer) }}">{{ block.producer }}</a>
                                {% else %}
                                Unknown
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="col-md-6">
                <table class="table table-borderless">
                    <tbody>
                        <tr>
                            <th style="width: 150px">Hash:</th>
                            <td><code class="hash">{{ block.hash }}</code></td>
                        </tr>
                        <tr>
                            <th>Previous Hash:</th>
                            <td>
                                {% if block.index > 0 %}
                                <a href="{{ url_for('block_detail', height=block.index-1) }}"><code class="hash">{{ block.previous_hash }}</code></a>
                                {% else %}
                                <code class="hash">{{ block.previous_hash }}</code>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Merkle Root:</th>
                            <td><code class="hash">{{ block.merkle_root|default('Not available') }}</code></td>
                        </tr>
                        <tr>
                            <th>Nonce:</th>
                            <td>{{ block.nonce }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        Block Transactions ({{ block.transactions|length }})
    </div>
    <div class="card-body p-0">
        {% if block.transactions %}
        <div class="table-responsive">
            <table class="table table-striped mb-0">
                <thead>
                    <tr>
                        <th>Hash</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tx in block.transactions %}
                    <tr>
                        <td>
                            {% if 'hash' in tx %}
                            <a href="{{ url_for('transaction_detail', tx_hash=tx.hash) }}" class="hash-truncated">{{ tx.hash }}</a>
                            {% else %}
                            <span class="text-muted">Hash not available</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if tx.sender == "network" %}
                            <span class="badge bg-success">Coinbase</span>
                            {% else %}
                            <a href="{{ url_for('address_detail', address=tx.sender) }}">{{ tx.sender_short|default(tx.sender) }}</a>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('address_detail', address=tx.recipient) }}">{{ tx.recipient_short|default(tx.recipient) }}</a>
                        </td>
                        <td>{{ tx.amount }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="p-4 text-center">
            <p>No transactions in this block</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- If block has signature, show verification section -->
{% if block.signature %}
<div class="card mt-4">
    <div class="card-header">
        Block Signature Verification
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6>Signature</h6>
                <code class="hash">{{ block.signature }}</code>
            </div>
            <div class="col-md-6">
                <h6>Producer Public Key</h6>
                <code class="hash">{{ block.pub_key|default('Not available') }}</code>
            </div>
        </div>
        <div class="mt-3">
            <span class="badge bg-success">Verified âœ“</span>
            <small class="text-muted ms-2">Block signature has been verified against the producer's public key</small>
        </div>
    </div>
</div>
{% endif %}

<!-- Block Raw JSON Data -->
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>Raw Block Data</span>
        <button class="btn btn-sm btn-primary" id="toggleRawData">Show/Hide</button>
    </div>
    <div class="card-body" id="rawDataContainer" style="display: none;">
        <pre id="rawBlockData">{{ block|tojson(indent=2) }}</pre>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle raw data visibility
        document.getElementById('toggleRawData').addEventListener('click', function() {
            const container = document.getElementById('rawDataContainer');
            if (container.style.display === 'none') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        });
        
        // Set blockchain stats for footer
        window.blockchainStats = {
            blockCount: '{{ blockchain_info.height|default("0") }}',
            txCount: '{{ blockchain_info.total_transactions|default("0") }}',
            nodeCount: '10+' // Placeholder value
        };
    });
</script>
{% endblock %}