{% extends "base.html" %}
{% block title %}Blockchain Explorer - QNet{% endblock %}
{% block bodyclass %}page-explorer{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Blockchain Explorer</h1>
        <form action="{{ url_for('search') }}" method="POST" class="d-flex">
            <input class="form-control me-2" type="search" name="query" placeholder="Search by block height, transaction hash, or address" aria-label="Search">
            <button class="btn btn-primary" type="submit">Search</button>
        </form>
    </div>

    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Blockchain Information</span>
            <a href="{{ url_for('explorer') }}" class="btn btn-primary btn-sm">Back to Explorer</a>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <div class="border rounded p-3 text-center h-100">
                        <h6 class="text-muted">Current Height</h6>
                        <div class="h4">{{ blockchain_info.height }}</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="border rounded p-3 text-center h-100">
                        <h6 class="text-muted">Total Transactions</h6>
                        <div class="h4">{{ blockchain_info.total_transactions|default('0') }}</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="border rounded p-3 text-center h-100">
                        <h6 class="text-muted">Total Coins Issued</h6>
                        <div class="h4">{{ blockchain_info.total_issued|default('0') }}</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="border rounded p-3 text-center h-100">
                        <h6 class="text-muted">Last Block Time</h6>
                        <div class="small">{{ blockchain_info.last_block_time }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-header">
            Network Activity
        </div>
        <div class="card-body">
            <canvas id="blockTimeChart" height="250"></canvas>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Example chart data - in a real application, this would be dynamically populated
        const blockTimes = [8.5, 9.2, 7.8, 10.1, 9.7, 8.3, 9.5, 10.2, 8.7, 9.0, 8.8, 9.3, 10.0, 8.9];
        const blockNumbers = [];
        
        // Calculate block numbers based on current height
        const currentHeight = {{ blockchain_info.height|default(0) }};
        for (let i = 0; i < blockTimes.length; i++) {
            blockNumbers.push(currentHeight - blockTimes.length + i + 1);
        }
        
        const ctx = document.getElementById('blockTimeChart').getContext('2d');
        const blockTimeChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: blockNumbers,
                datasets: [{
                    label: 'Block Time (seconds)',
                    data: blockTimes,
                    fill: true,
                    borderColor: 'rgba(110, 142, 251, 1)',
                    backgroundColor: 'rgba(110, 142, 251, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 4,
                    pointBackgroundColor: 'rgba(110, 142, 251, 1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Block Time (seconds)'
                        },
                        grid: {
                            color: document.body.classList.contains('dark-mode') ? 
                                'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Block Height'
                        },
                        grid: {
                            color: document.body.classList.contains('dark-mode') ? 
                                'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                return 'Block #' + tooltipItems[0].label;
                            }
                        }
                    }
                }
            }
        });
        
        // Set blockchain stats for footer
        window.blockchainStats = {
            blockCount: '{{ blockchain_info.height|default("0") }}',
            txCount: '{{ blockchain_info.total_transactions|default("0") }}',
            nodeCount: '10+' // Placeholder value
        };
    });
</script>
{% endblock %}

    <div class="card mt-4">
        <div class="card-header">
            Recent Blocks
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Height</th>
                            <th>Hash</th>
                            <th>Time</th>
                            <th>Transactions</th>
                            <th>Producer</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for block in blocks %}
                        <tr>
                            <td>{{ block.index }}</td>
                            <td><code class="hash-truncated">{{ block.hash }}</code></td>
                            <td>{{ block.time_ago }}</td>
                            <td>{{ block.transaction_count }}</td>
                            <td>{{ block.producer }}</td>
                            <td>
                                <a href="{{ url_for('block_detail', height=block.index) }}" class="btn btn-sm btn-primary">View</a>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center">No blocks available</td>
                        </tr>
                        {% endfor %}