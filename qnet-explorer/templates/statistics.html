{% extends "base.html" %}
{% block title %}Network Statistics - QNet Blockchain{% endblock %}
{% block bodyclass %}page-statistics{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">Network Statistics</h1>
    <div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm btn-outline-primary active" data-period="24h">24 Hours</button>
            <button type="button" class="btn btn-sm btn-outline-primary" data-period="7d">7 Days</button>
            <button type="button" class="btn btn-sm btn-outline-primary" data-period="30d">30 Days</button>
            <button type="button" class="btn btn-sm btn-outline-primary" data-period="all">All Time</button>
        </div>
    </div>
</div>

<!-- Key Metrics Summary -->
<div class="row mb-4">
    <div class="col-md-3 mb-4">
        <div class="card stats-card">
            <h5>Current Height</h5>
            <p class="value">{{ blockchain_info.height|default('0') }}</p>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card stats-card">
            <h5>Active Nodes</h5>
            <p class="value">{{ network_stats.active_nodes|default('0') }}</p>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card stats-card">
            <h5>Avg Block Time</h5>
            <p class="value">{{ network_stats.avg_block_time|default('0')|round(2) }}s</p>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card stats-card">
            <h5>Current TPS</h5>
            <p class="value">{{ network_stats.current_tps|default('0')|round(2) }}</p>
        </div>
    </div>
</div>

<!-- Network Activity Chart -->
<div class="card mb-4">
    <div class="card-header">
        Network Activity
    </div>
    <div class="card-body">
        <canvas id="networkActivityChart" height="250"></canvas>
    </div>
</div>

<!-- Transaction & Block Stats -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                Transaction Statistics
            </div>
            <div class="card-body">
                <table class="table">
                    <tbody>
                        <tr>
                            <th>Total Transactions</th>
                            <td>{{ blockchain_info.total_transactions|default('0') }}</td>
                        </tr>
                        <tr>
                            <th>Avg Transactions Per Block</th>
                            <td>{{ (blockchain_info.total_transactions / blockchain_info.height)|default('0')|round(2) if blockchain_info.height > 0 else '0' }}</td>
                        </tr>
                        <tr>
                            <th>Current TPS</th>
                            <td>{{ network_stats.current_tps|default('0')|round(2) }}</td>
                        </tr>
                        <tr>
                            <th>Peak TPS</th>
                            <td>{{ network_stats.peak_tps|default('0')|round(2) }}</td>
                        </tr>
                        <tr>
                            <th>Avg Transaction Fee</th>
                            <td>{{ network_stats.avg_tx_fee|default('0') }} QNet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                Block Statistics
            </div>
            <div class="card-body">
                <table class="table">
                    <tbody>
                        <tr>
                            <th>Total Blocks</th>
                            <td>{{ blockchain_info.height|default('0') + 1 }}</td>
                        </tr>
                        <tr>
                            <th>Average Block Time</th>
                            <td>{{ network_stats.avg_block_time|default('0')|round(2) }} seconds</td>
                        </tr>
                        <tr>
                            <th>Current Block Reward</th>
                            <td>{{ network_stats.current_reward|default('0') }} QNet</td>
                        </tr>
                        <tr>
                            <th>Total Supply</th>
                            <td>{{ blockchain_info.total_issued|default('0') }} QNet</td>
                        </tr>
                        <tr>
                            <th>Last Block</th>
                            <td>{{ blockchain_info.last_block_time|default('N/A') }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Block Time Distribution -->
<div class="card mb-4">
    <div class="card-header">
        Block Time Distribution
    </div>
    <div class="card-body">
        <canvas id="blockTimeDistributionChart" height="250"></canvas>
    </div>
</div>

<!-- Network Growth -->
<div class="card mb-4">
    <div class="card-header">
        Network Growth
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <canvas id="blockGrowthChart" height="250"></canvas>
            </div>
            <div class="col-md-6">
                <canvas id="addressesGrowthChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Node Distribution -->
<div class="card mb-4">
    <div class="card-header">
        Node Distribution
    </div>
    <div class="card-body">
        <div id="nodeMapContainer" style="height: 400px;"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set chart color scheme based on mode
        const isDarkMode = document.body.classList.contains('dark-mode');
        const chartTextColor = isDarkMode ? '#f8f9fa' : '#343a40';
        const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        
        Chart.defaults.color = chartTextColor;
        Chart.defaults.borderColor = gridColor;
        
        // Network Activity Chart - using the chart data passed from the backend
        const networkActivityCtx = document.getElementById('networkActivityChart').getContext('2d');
        const networkActivityChart = new Chart(networkActivityCtx, {
            type: 'line',
            data: {
                labels: {{ chart_data.labels|safe }},
                datasets: [{
                    label: 'Transactions',
                    data: {{ chart_data.transaction_counts|safe }},
                    borderColor: 'rgba(110, 142, 251, 1)',
                    backgroundColor: 'rgba(110, 142, 251, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                },
                {
                    label: 'Blocks',
                    data: {{ chart_data.block_counts|safe }},
                    borderColor: 'rgba(167, 119, 227, 1)',
                    backgroundColor: 'rgba(167, 119, 227, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: gridColor
                        }
                    },
                    x: {
                        grid: {
                            color: gridColor
                        }
                    }
                }
            }
        });
        
        // Block Time Distribution Chart - simulation data
        const blockTimes = [5, 8, 12, 15, 10, 9, 6, 7, 8, 9, 10, 11, 12, 13, 14];
        const blockTimeDistribution = [0, 0, 0, 0, 2, 3, 5, 7, 6, 5, 4, 3, 2, 1, 0];
        
        const blockTimeCtx = document.getElementById('blockTimeDistributionChart').getContext('2d');
        const blockTimeChart = new Chart(blockTimeCtx, {
            type: 'bar',
            data: {
                labels: blockTimes.map(time => `${time} sec`),
                datasets: [{
                    label: 'Number of Blocks',
                    data: blockTimeDistribution,
                    backgroundColor: 'rgba(74, 222, 128, 0.6)',
                    borderColor: 'rgba(74, 222, 128, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                return `Block Time: ${tooltipItems[0].label}`;
                            },
                            label: function(context) {
                                return `Count: ${context.raw} blocks`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Blocks'
                        },
                        grid: {
                            color: gridColor
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Block Time (seconds)'
                        },
                        grid: {
                            color: gridColor
                        }
                    }
                }
            }
        });
        
        // Block Growth Chart - simulation data
        const dates = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const blockGrowth = [100, 250, 450, 700, 1000, 1400, 1900, 2500, 3200, 4000, 4900, 5900];
        
        const blockGrowthCtx = document.getElementById('blockGrowthChart').getContext('2d');
        const blockGrowthChart = new Chart(blockGrowthCtx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Total Blocks',
                    data: blockGrowth,
                    borderColor: 'rgba(110, 142, 251, 1)',
                    backgroundColor: 'rgba(110, 142, 251, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Cumulative Block Growth'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: gridColor
                        }
                    },
                    x: {
                        grid: {
                            color: gridColor
                        }
                    }
                }
            }
        });
        
        // Addresses Growth Chart - simulation data
        const addressGrowth = [50, 120, 200, 350, 500, 700, 950, 1250, 1600, 2000, 2500, 3200];
        
        const addressesGrowthCtx = document.getElementById('addressesGrowthChart').getContext('2d');
        const addressesGrowthChart = new Chart(addressesGrowthCtx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Total Addresses',
                    data: addressGrowth,
                    borderColor: 'rgba(74, 222, 128, 1)',
                    backgroundColor: 'rgba(74, 222, 128, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Cumulative Address Growth'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: gridColor
                        }
                    },
                    x: {
                        grid: {
                            color: gridColor
                        }
                    }
                }
            }
        });
        
        // Period selection
        const periodButtons = document.querySelectorAll('[data-period]');
        periodButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Update UI
                periodButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                // Get selected period
                const period = button.getAttribute('data-period');
                
                // Update charts based on selected period
                // In a real application, this would make AJAX requests to get data for the selected period
                // For demonstration, we'll just simulate different data
                
                // Update footer stats
                window.blockchainStats = {
                    blockCount: '{{ blockchain_info.height|default("0") }}',
                    txCount: '{{ blockchain_info.total_transactions|default("0") }}',
                    nodeCount: '{{ network_stats.active_nodes|default("10+") }}'
                };
            });
        });
        
        // Set blockchain stats for footer
        window.blockchainStats = {
            blockCount: '{{ blockchain_info.height|default("0") }}',
            txCount: '{{ blockchain_info.total_transactions|default("0") }}',
            nodeCount: '{{ network_stats.active_nodes|default("10+") }}'
        };
        
        // Placeholder for node map
        const nodeMapContainer = document.getElementById('nodeMapContainer');
        nodeMapContainer.innerHTML = '<div class="text-center p-5"><p class="mb-3">Node Distribution Map</p><p class="text-muted">Node visualization requires geo-location data from the network.</p></div>';
    });
</script>
{% endblock %}